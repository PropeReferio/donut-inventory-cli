#!/usr/bin/env python

#Hopefully this URL doesn't change
#https://five-daughters-bakery.square.site/s/order?location=11ea670d96d28035a53a0cc47a2b63cc
import time
import datetime
import argparse

from selenium import webdriver
from bs4 import BeautifulSoup

def get_html():
	driver = webdriver.Chrome()
	driver.get('https://five-daughters-bakery.square.site/s/order?location=11ea670d96d28035a53a0cc47a2b63cc')

	#To ensure that the page is loaded
	time.sleep(5)

	#This renders the JS code and stores all the info in static HTML.
	html = driver.page_source
	soup = BeautifulSoup(html, "html.parser")

	products = soup.find_all('div', {'class': 'meta'})
	# Can remove products maybe...
	names = [product.find('p', {'class': 'w-product-title'}) for product in products]
	availabilities = [product.find('div', {'class': 'stock-tag'}) for product in products]
	prices = [product.find('span', {'class': 'font--product-price'}) for product in products]
	return names, availabilities, prices

def get_output(names, availabilities, prices, diet):
	output = str(datetime.datetime.now()) + '\n'
	for i in range(len(names)):
		if diet in names[i].text:
			if availabilities[i]:
				output += prices[i].text.strip() + '  |  ' + names[i].text.strip() + '  |  ' + availabilities[i].text.strip() + '\n'
			else:
				output += prices[i].text.strip() + '  |  ' + names[i].text.strip() + '\n'

	return output

def Main():
	parser = argparse.ArgumentParser()
	diet_group = parser.add_mutually_exclusive_group(required=True)
	diet_group.add_argument("-o", "--omni", help="Shows availability of all \
		donuts.", action="store_true")
	diet_group.add_argument("-p", "--paleo", help="Shows availability of paleo \
		donuts.", action="store_true")
	diet_group.add_argument("-v", "--vegan", help="Shows availability of vegan \
		donuts.", action="store_true")
	parser.add_argument("-f", "--file", help="Filename to write output to.",
	type=str)

	args = parser.parse_args()
	names, availabilities, prices = get_html()
	if args.omni:
		print("Showing all donuts: ")
		output = get_output(names, availabilities, prices, '')
	elif args.paleo:
		print("Showing paleo donuts only: ")
		output = get_output(names, availabilities, prices, 'Paleo')
	elif args.vegan:
		print("Showing vegan donuts only: ")
		output = get_output(names, availabilities, prices, 'Vegan')
	
	print(output)

	if args.file:
		with open(args.file, "a") as f:
			f.write(output)

if __name__ == "__main__":
	Main()